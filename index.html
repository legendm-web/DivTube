<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Purify Video ‚Äì Intentional YouTube</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&display=swap" rel="stylesheet">
    
    <style id="custom-theme-vars">
        :root {
            --bg: #f4f4f5; --text: #1f1f1f; --card-bg: #ffffff;
            --primary: #46aae9; --accent: rgba(0,0,0,0.05);
        }
    </style>

    <style>
        * { box-sizing: border-box; font-family: 'Noto Sans', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); transition: background 0.3s; }

        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.8rem 2rem; background: var(--card-bg);
            position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logo { font-weight: 600; font-size: 1.2rem; cursor: pointer; color: var(--primary); }
        
        .floating-panel {
            display: none; position: fixed; top: 70px; right: 20px;
            background: var(--card-bg); padding: 1.5rem; border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 1000;
            border: 1px solid var(--primary); min-width: 320px;
        }

        button { padding: 0.6rem 1rem; background: var(--primary); border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; }
        button.secondary { background: var(--accent); color: var(--text); }
        button.train { background: #10b981; font-size: 0.8rem; padding: 4px 8px; }
        
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; }
        #watch-view { display: none; grid-template-columns: 1fr 380px; gap: 2rem; }
        
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; }
        .video-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; }
        .video-card:hover { transform: translateY(-5px); }
        .video-card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .video-info { padding: 1rem; }

        #reading-mode-content { 
            display: none; background: var(--card-bg); padding: 2rem; 
            border-radius: 12px; line-height: 1.8; margin-top: 1rem; border: 1px solid var(--accent);
        }

        .training-banner {
            background: #10b98122; border: 1px solid #10b981; padding: 10px; 
            border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
        }

        #loading-trigger { height: 100px; display: flex; align-items: center; justify-content: center; opacity: 0.5; }

        iframe { width: 100%; aspect-ratio: 16/9; border-radius: 12px; border: none; background: #000; }
        @media (max-width: 1000px) { #watch-view { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<nav>
    <div class="logo" onclick="showHome()">‚ú® Purify</div>
    <form onsubmit="handleSearch(event)">
        <input type="text" id="searchInput" placeholder="Search intentionally..." style="padding:0.6rem; border-radius:8px; border:1px solid var(--primary); width:280px;"/>
    </form>
    <div class="nav-right">
        <button class="secondary" onclick="togglePanel('algo-panel')">‚öôÔ∏è Algorithm</button>
        <button class="secondary" onclick="togglePanel('theme-panel')">üé® Theme</button>
    </div>
</nav>

<div id="algo-panel" class="floating-panel">
    <h3 style="margin-top:0">Active Learning</h3>
    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
        <input type="checkbox" id="allow-learning" onchange="toggleLearning()"> Allow Algorithm to Learn
    </label>
    <p style="font-size:0.8rem; opacity:0.7;">When enabled, Purify analyzes watch patterns and keywords to refine your feed.</p>
    <hr>
    <button class="secondary" style="width:100%" onclick="resetBrain()">Reset AI Brain</button>
</div>

<div id="theme-panel" class="floating-panel">
    <h3>Theme Architect</h3>
    <label>Background</label><input type="color" id="c-bg" oninput="applyTheme()" style="width:100%;">
    <label>Text</label><input type="color" id="c-text" oninput="applyTheme()" style="width:100%;">
    <label>Card</label><input type="color" id="c-card" oninput="applyTheme()" style="width:100%;">
    <button onclick="togglePanel('theme-panel')" style="width:100%; margin-top:10px;">Close</button>
</div>

<div class="container">
    <div id="home-view">
        <div id="training-status" class="training-banner" style="display:none;">
            <span>üß† AI is currently learning from your focus.</span>
            <button class="secondary" style="font-size:0.7rem;" onclick="togglePanel('algo-panel')">Settings</button>
        </div>
        <h2 id="feedTitle">Your Intentional Feed</h2>
        <div id="home-results" class="video-grid"></div>
        <div id="loading-trigger">Loading more...</div>
    </div>

    <div id="watch-view">
        <div class="video-section">
            <iframe id="mainPlayer" allowfullscreen></iframe>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:1.5rem;">
                <h2 id="v-title" style="margin:0;"></h2>
                <div style="display:flex; gap:10px;">
                    <button id="trainBtn" class="train" onclick="trainOnCurrent()" style="display:none;">üëç Train AI</button>
                    <button class="secondary" onclick="toggleReadingMode()">üìñ Read</button>
                </div>
            </div>
            <p id="v-channel" style="opacity:0.6;"></p>
            <div id="reading-mode-content"></div>
        </div>
        <div class="sidebar">
            <h3>Related Context</h3>
            <div id="sidebar-results" style="display:flex; flex-direction:column; gap:1rem;"></div>
        </div>
    </div>
</div>

<script>
const API_KEY = "AIzaSyAsiXire2Ls6HrwkS7tIFNqkNi5xpySeCg";

let state = {
    interests: JSON.parse(localStorage.getItem("interests")) || {},
    learningEnabled: localStorage.getItem("learningEnabled") === "true",
    nextPageToken: "",
    currentQuery: "",
    isFetching: false,
    theme: JSON.parse(localStorage.getItem("customTheme")) || {bg: "#f4f4f5", text: "#1f1f1f", card: "#ffffff"}
};

/* --- THEME --- */
function applyTheme() {
    state.theme = { bg: document.getElementById('c-bg').value, text: document.getElementById('c-text').value, card: document.getElementById('c-card').value };
    document.getElementById('custom-theme-vars').innerHTML = `:root { --bg: ${state.theme.bg}; --text: ${state.theme.text}; --card-bg: ${state.theme.card}; --primary: #46aae9; --accent: rgba(125,125,125,0.1); }`;
    localStorage.setItem("customTheme", JSON.stringify(state.theme));
}

function togglePanel(id) {
    const el = document.getElementById(id);
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
}

/* --- LEARNING SYSTEM --- */
function toggleLearning() {
    state.learningEnabled = document.getElementById("allow-learning").checked;
    localStorage.setItem("learningEnabled", state.learningEnabled);
    document.getElementById("training-status").style.display = state.learningEnabled ? "flex" : "none";
    document.getElementById("trainBtn").style.display = state.learningEnabled ? "block" : "none";
}

function updateAlgorithm(title) {
    if (!state.learningEnabled) return;
    const ignore = ["the", "and", "how", "with", "video", "2025", "2026", "official"];
    title.toLowerCase().replace(/[^\w\s]/gi, '').split(' ').forEach(w => {
        if(w.length > 3 && !ignore.includes(w)) {
            state.interests[w] = (state.interests[w] || 0) + 1;
        }
    });
    localStorage.setItem("interests", JSON.stringify(state.interests));
}

function trainOnCurrent() {
    const title = document.getElementById("v-title").innerText;
    updateAlgorithm(title + " analysis documentary depth");
    alert("Algorithm refined: prioritizing deeper content on this topic.");
}

function resetBrain() {
    if(confirm("Erase all learned patterns?")) {
        state.interests = {};
        localStorage.setItem("interests", "{}");
        location.reload();
    }
}

/* --- DATA FETCHING --- */
async function fetchVideos(query, append = false) {
    if (state.isFetching) return;
    state.isFetching = true;
    state.currentQuery = query;

    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=15&q=${encodeURIComponent(query)}&pageToken=${append ? state.nextPageToken : ""}&key=${API_KEY}`;
    
    try {
        const res = await fetch(url);
        const data = await res.json();
        state.nextPageToken = data.nextPageToken || "";
        renderGrid(data.items, append);
    } catch (e) { console.error("API limit or error"); }
    state.isFetching = false;
}

function renderGrid(items, append) {
    const container = document.getElementById("home-results");
    if (!append) container.innerHTML = "";
    items.forEach(item => {
        if (!item.id.videoId) return;
        const card = document.createElement("div");
        card.className = "video-card";
        card.innerHTML = `<img src="${item.snippet.thumbnails.medium.url}"><div class="video-info"><strong>${item.snippet.title}</strong><small>${item.snippet.channelTitle}</small></div>`;
        card.onclick = () => openWatch(item.id.videoId, item.snippet.title, item.snippet.channelTitle, item.snippet.description);
        container.appendChild(card);
    });
}

// Infinite Scroll
const scrollObserver = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting && state.nextPageToken && !state.isFetching && document.getElementById("home-view").style.display !== "none") {
        fetchVideos(state.currentQuery, true);
    }
}, { threshold: 0.1 });
scrollObserver.observe(document.getElementById("loading-trigger"));

function openWatch(id, title, channel, desc) {
    document.getElementById("home-view").style.display = "none";
    document.getElementById("watch-view").style.display = "grid";
    document.getElementById("mainPlayer").src = `https://www.youtube-nocookie.com/embed/${id}?autoplay=1`;
    document.getElementById("v-title").innerText = title;
    document.getElementById("v-channel").innerText = channel;
    document.getElementById("reading-mode-content").innerText = desc;
    
    updateAlgorithm(title);
    fetchSidebar(title.split(" ").slice(0, 2).join(" "));
    window.scrollTo(0,0);
}

async function fetchSidebar(q) {
    const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=8&q=${encodeURIComponent(q)}&key=${API_KEY}`);
    const data = await res.json();
    const side = document.getElementById("sidebar-results");
    side.innerHTML = "";
    data.items.forEach(item => {
        const div = document.createElement("div");
        div.className = "video-card";
        div.style.fontSize = "0.85rem";
        div.innerHTML = `<img src="${item.snippet.thumbnails.medium.url}"><div class="video-info"><b>${item.snippet.title}</b></div>`;
        div.onclick = () => openWatch(item.id.videoId, item.snippet.title, item.snippet.channelTitle, item.snippet.description);
        side.appendChild(div);
    });
}

function loadFeed() {
    let q = "Intentional Living Documentary";
    const top = Object.entries(state.interests).sort((a,b)=>b[1]-a[1]).slice(0,2).map(i=>i[0]);
    if (top.length) {
        const mod = ["Analysis", "History", "Review", "Retrospective"][Math.floor(Math.random()*4)];
        q = `${top.join(" ")} ${mod}`;
    }
    fetchVideos(q);
}

function handleSearch(e) {
    e.preventDefault();
    const q = document.getElementById("searchInput").value;
    document.getElementById("feedTitle").innerText = `Results: ${q}`;
    fetchVideos(q);
}

function showHome() {
    document.getElementById("home-view").style.display = "block";
    document.getElementById("watch-view").style.display = "none";
    document.getElementById("mainPlayer").src = "";
    loadFeed();
}

function toggleReadingMode() {
    const content = document.getElementById("reading-mode-content");
    content.style.display = content.style.display === "block" ? "none" : "block";
}

/* --- INIT --- */
document.getElementById('allow-learning').checked = state.learningEnabled;
document.getElementById('c-bg').value = state.theme.bg;
document.getElementById('c-text').value = state.theme.text;
document.getElementById('c-card').value = state.theme.card;
if (state.learningEnabled) document.getElementById("training-status").style.display = "flex";
applyTheme();
loadFeed();
</script>
</body>
</html>
