<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>DivTube Sovereign v20.0</title>
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #010204; --sidebar: #06080c; --card: #0c0f16;
            --primary: #8b5cf6; --text: #f1f5f9; --border: rgba(255,255,255,0.06);
            --accent: #10b981; --warn: #ef4444;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; transition: 0.2s; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        aside { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; z-index: 100; }
        .logo { font-weight: 900; font-size: 1.8rem; color: var(--primary); letter-spacing: -2px; cursor: pointer; margin-bottom: 2rem; }
        .nav-item { padding: 12px; border-radius: 12px; cursor: pointer; color: rgba(255,255,255,0.4); font-weight: 700; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; text-decoration: none; font-size: 0.9rem; }
        .nav-item.active { background: rgba(139, 92, 246, 0.15); color: var(--primary); border: 1px solid rgba(139, 92, 246, 0.2); }

        main { flex: 1; overflow-y: auto; background: radial-gradient(circle at top right, #0d1117, #010204); }
        .view { display: none; padding: 2rem; max-width: 1400px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        .active-view { display: block; }

        /* Theater */
        #view-watch { padding: 0; max-width: 100%; height: 100vh; background: #000; }
        .theater-frame { width: 100%; height: 80vh; border: none; }
        
        /* History & List Styles */
        .history-item { background: var(--card); border: 1px solid var(--border); border-radius: 15px; padding: 15px; display: flex; align-items: center; gap: 20px; margin-bottom: 10px; }
        .history-item img { width: 120px; border-radius: 8px; }
        .history-info { flex: 1; }
        .remove-btn { background: none; border: 1px solid var(--warn); color: var(--warn); padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 11px; font-weight: 800; }
        
        .blank-node-btn { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 12px; margin-top: 10px; width: 100%; }
        
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 2rem; }
        .card { background: var(--card); border-radius: 20px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; position: relative; }
        .card img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<aside>
    <div class="logo" onclick="app.nav('/home')">DivTube</div>
    <nav>
        <div class="nav-item" id="link-home" onclick="app.nav('/home')">üì° Neural Feed</div>
        <div class="nav-item" id="link-history" onclick="app.nav('/history')">üìú History</div>
        <div class="nav-item" id="link-settings" onclick="app.nav('/settings')">‚öôÔ∏è AI Core</div>
    </nav>
    
    <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border);">
        <button class="blank-node-btn" onclick="app.openBlank()">+ Spawn Blank Node</button>
    </div>
</aside>

<main>
    <section id="view-home" class="view">
        <input type="text" id="searchBox" placeholder="Inject Search Intent..." style="width:100%; background:rgba(255,255,255,0.03); border:1px solid var(--border); color:white; padding:20px 30px; border-radius:100px; font-size:1.1rem; outline:none; margin-bottom: 2rem;" onkeydown="if(event.key==='Enter') app.search()">
        <div id="grid" class="video-grid"></div>
    </section>

    <section id="view-watch" class="view">
        <div id="theater-mount"></div>
        <div style="padding: 2rem 4rem; display: flex; justify-content: space-between; align-items: center;">
            <h1 id="t-title" style="margin:0; font-size:2rem; font-weight:900;"></h1>
            <button onclick="app.nav('/home')" style="background:var(--primary); color:white; border:none; padding:12px 30px; border-radius:10px; cursor:pointer; font-weight:800;">EXIT</button>
        </div>
    </section>

    <section id="view-history" class="view">
        <h1 style="font-weight:900; font-size:2.5rem;">Neural History</h1>
        <p style="color:#555; margin-bottom:2rem;">Manage your training data. Deleting an item removes its influence from the Python AI.</p>
        <div id="history-list"></div>
    </section>

    <section id="view-settings" class="view">
        <h1 style="font-weight:900; font-size:2.5rem;">AI Settings</h1>
        <div style="max-width: 600px; margin-top: 2rem;">
            <label style="font-size:10px; font-weight:900; color:var(--primary);">YOUTUBE_API_KEY</label>
            <input type="password" id="ytKey" style="width:100%; background:#000; border:1px solid var(--border); color:white; padding:15px; border-radius:12px; margin:10px 0 20px 0;">
            <button onclick="app.saveKey()" style="background:var(--primary); color:white; border:none; padding:15px; border-radius:12px; font-weight:800; cursor:pointer; width:100%;">SYNC ENGINE</button>
        </div>
    </section>
</main>

<script type="py">
import json
from js import window

class SovereignAI:
    def rank(self, candidates_json, brain_json):
        candidates = json.loads(candidates_json)
        brain = json.loads(brain_json)
        weights = brain.get("weights", {})
        
        for v in candidates:
            v['score'] = weights.get(v['channelId'], {"points": 1.0})['points']
            v['reason'] = f"W_Score: {v['score']:.1f}"
            
        candidates.sort(key=lambda x: x['score'], reverse=True)
        return json.dumps(candidates)

engine = SovereignAI()
window.pyRanker = engine.rank
</script>

<script>
const app = {
    db: JSON.parse(localStorage.getItem('div_v20')) || { key: "", history: [], brain: { weights: {} } },

    init() {
        document.getElementById('ytKey').value = this.db.key;
        window.onpopstate = () => this.route();
        this.route();
    },

    nav(path) {
        window.history.pushState({}, "", path);
        this.route();
    },

    route() {
        const path = window.location.pathname === '/' ? '/home' : window.location.pathname;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        const target = document.getElementById(`view-${path.replace('/', '')}`);
        if(target) target.classList.add('active-view');
        
        const link = document.getElementById(`link-${path.replace('/', '')}`);
        if(link) link.classList.add('active');

        if(path === '/history') this.renderHistory();
        if(path !== '/watch') document.getElementById('theater-mount').innerHTML = "";
    },

    async search() {
        const q = document.getElementById('searchBox').value;
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${q}&maxResults=15&type=video&key=${this.db.key}`);
        const data = await res.json();
        const raw = data.items.map(i => ({ id: i.id.videoId, channelId: i.snippet.channelId, title: i.snippet.title, thumb: i.snippet.thumbnails.high.url }));
        const ranked = JSON.parse(window.pyRanker(JSON.stringify(raw), JSON.stringify(this.db.brain)));
        
        const grid = document.getElementById('grid'); grid.innerHTML = "";
        ranked.forEach(v => {
            const c = document.createElement('div'); c.className = 'card';
            c.innerHTML = `<img src="${v.thumb}"><div style="padding:15px; font-weight:800;">${v.title}</div>`;
            c.onclick = () => this.play(v);
            grid.appendChild(c);
        });
    },

    play(v) {
        this.nav('/watch');
        document.getElementById('theater-mount').innerHTML = `<iframe class="theater-frame" src="https://www.youtube-nocookie.com/embed/${v.id}?autoplay=1" allowfullscreen></iframe>`;
        document.getElementById('t-title').innerText = v.title;
        
        // Add to history
        this.db.history.unshift({...v, timestamp: Date.now()});
        if(!this.db.brain.weights[v.channelId]) this.db.brain.weights[v.channelId] = { points: 1.0 };
        this.db.brain.weights[v.channelId].points += 0.5;
        this.save();
    },

    renderHistory() {
        const container = document.getElementById('history-list');
        container.innerHTML = "";
        this.db.history.forEach((v, index) => {
            const h = document.createElement('div'); h.className = 'history-item';
            h.innerHTML = `
                <img src="${v.thumb}">
                <div class="history-info">
                    <div style="font-weight:800;">${v.title}</div>
                    <div style="font-size:12px; color:#555;">Watched: ${new Date(v.timestamp).toLocaleDateString()}</div>
                </div>
                <button class="remove-btn" onclick="app.removeHistory(${index}, '${v.channelId}')">PURGE</button>
            `;
            container.appendChild(h);
        });
    },

    removeHistory(index, cid) {
        this.db.history.splice(index, 1);
        if(this.db.brain.weights[cid]) this.db.brain.weights[cid].points -= 0.5; // Reverse training
        this.save(); this.renderHistory();
    },

    openBlank() {
        const win = window.open('about:blank', '_blank');
        win.document.write('<html><body style="background:#000;color:#fff;display:flex;align-items:center;justify-content:center;font-family:sans-serif;"><h1>DivTube Blank Node</h1></body></html>');
    },

    saveKey() { this.db.key = document.getElementById('ytKey').value; this.save(); location.reload(); },
    save() { localStorage.setItem('div_v20', JSON.stringify(this.db)); }
};

app.init();
</script>
</body>
</html>
