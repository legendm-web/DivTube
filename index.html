<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>DivTube Sovereign v37.0</title>
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #010204; --sidebar: #06080c; --card: #0c0f16;
            --primary: #8b5cf6; --text: #f1f5f9; --border: rgba(255,255,255,0.06);
            --sub: #f59e0b; --warn: #ef4444; --like: #3b82f6;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        aside { width: 240px; background: var(--sidebar); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; flex-shrink: 0; }
        .logo { font-weight: 900; font-size: 1.8rem; color: var(--primary); letter-spacing: -2px; cursor: pointer; margin-bottom: 2rem; }
        .nav-item { padding: 12px; border-radius: 12px; cursor: pointer; color: rgba(255,255,255,0.4); font-weight: 700; margin-bottom: 5px; text-decoration: none; display: flex; align-items: center; gap: 10px; }
        .nav-item.active { background: rgba(139, 92, 246, 0.1); color: var(--primary); }

        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { padding: 1rem 2rem; border-bottom: 1px solid var(--border); display: flex; gap: 20px; background: var(--bg); z-index: 100; }
        .content-area { flex: 1; overflow-y: auto; padding: 2rem; background: radial-gradient(circle at top right, #0d1117, #010204); }

        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); transition: 0.2s; cursor: pointer; }
        .card:hover { border-color: var(--primary); transform: translateY(-2px); }
        
        /* Watch Layout */
        .watch-grid { display: grid; grid-template-columns: 1fr 380px; gap: 2rem; max-width: 1700px; margin: 0 auto; }
        .theater-container { position: relative; width: 100%; padding-top: 56.25%; background: #000; border-radius: 16px; overflow: hidden; border: 1px solid var(--border); }
        .theater-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        /* Autoplay Overlay */
        #autoplay-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 10; backdrop-filter: blur(5px); }
        .timer-circle { width: 80px; height: 80px; border: 4px solid var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 900; margin-bottom: 1rem; }

        .btn { padding: 10px 20px; border-radius: 100px; border: none; font-weight: 800; cursor: pointer; }
        #boot-screen { position: fixed; inset: 0; background: #000; z-index: 20000; display: flex; align-items: center; justify-content: center; font-weight: 900; color: var(--primary); }
    </style>
</head>
<body>

<div id="boot-screen">INITIATING_STREAM_LOGIC_V37...</div>

<aside>
    <div class="logo" onclick="app.nav('/home')">DivTube</div>
    <a class="nav-item" id="link-home" onclick="app.nav('/home')">üì° Home Feed</a>
    <a class="nav-item" id="link-search" onclick="app.nav('/search')" style="display:none;">üîç Search</a>
    <a class="nav-item" id="link-history" onclick="app.nav('/history')">üìú History</a>
    <a class="nav-item" id="link-settings" onclick="app.nav('/settings')">‚öôÔ∏è AI Core</a>
</aside>

<main>
    <div class="top-bar">
        <input type="text" id="globalSearch" placeholder="Inject Search Intent..." style="flex:1; background:var(--card); border:1px solid var(--border); color:white; padding:12px 20px; border-radius:100px; outline:none;" onkeydown="if(event.key==='Enter') app.search(this.value)">
    </div>

    <div class="content-area" id="main-scroll">
        <section id="view-home" class="view" style="display:none;"><div id="home-grid" class="video-grid"></div></section>
        <section id="view-search" class="view" style="display:none;"><div id="search-grid" class="video-grid"></div></section>
        <section id="view-history" class="view" style="display:none;"><div id="history-grid" class="video-grid"></div></section>

        <section id="view-watch" class="view" style="display:none;">
            <div class="watch-grid">
                <div class="main-player">
                    <div class="theater-container">
                        <div id="theater-mount"></div>
                        <div id="autoplay-overlay">
                            <div class="timer-circle" id="auto-timer">7</div>
                            <div style="font-weight:900;">NEXT_STREAM_INCOMING</div>
                            <button class="btn" style="margin-top:15px; background:var(--warn); color:white;" onclick="app.cancelAutoplay()">CANCEL</button>
                        </div>
                    </div>
                    <h1 id="t-title" style="margin:20px 0 10px 0; font-size:1.5rem; font-weight:900;"></h1>
                    <div style="display:flex; align-items:center; gap:15px; border-bottom:1px solid var(--border); padding-bottom:15px;">
                        <div id="watch-channel-name" style="font-weight:900; margin-right:auto; color:var(--primary);"></div>
                        <button id="btn-like" class="btn" onclick="app.toggleLike()" style="background:rgba(255,255,255,0.05); color:white;">üëç Like</button>
                        <button id="btn-sub-watch" class="btn" onclick="app.toggleSub()" style="background:var(--text); color:black;">SUBSCRIBE</button>
                    </div>
                    <div id="t-desc" style="background:var(--card); padding:20px; border-radius:12px; margin-top:20px; font-size:14px; color:#aaa; line-height:1.6; white-space:pre-wrap;"></div>
                </div>
                <div id="rec-sidebar"></div>
            </div>
        </section>

        <section id="view-settings" class="view" style="display:none;">
            <div style="max-width:400px; background:var(--card); padding:2rem; border-radius:16px;">
                <input type="password" id="ytKey" placeholder="API KEY" style="width:100%; padding:12px; background:#000; border:1px solid var(--border); color:white; border-radius:8px;">
                <button class="btn" style="background:var(--primary); color:white; width:100%; margin-top:10px;" onclick="app.saveKey()">REBOOT SYSTEM</button>
            </div>
        </section>
    </div>
</main>

<script type="py">
import json
from js import window

class SovereignAI:
    def rank(self, pool_json, brain_json):
        pool = json.loads(pool_json)
        brain = json.loads(brain_json)
        subs = brain.get("subs", [])
        for v in pool:
            v['score'] = 1000 if v['channelId'] in subs else 1
        pool.sort(key=lambda x: x['score'], reverse=True)
        return json.dumps(pool)

engine = SovereignAI()
window.pyRanker = engine.rank
window.app.onEngineReady()
</script>

<script>
const app = {
    basePath: window.location.pathname.startsWith('/DivTube') ? '/DivTube' : '',
    db: JSON.parse(localStorage.getItem('div_v37')) || { key: "", pool: [], brain: { subs: [], liked: [], history: [] } },
    searchBuffer: [],
    relatedBuffer: [],
    engineReady: false,
    autoTimer: null,

    init() {
        document.getElementById('ytKey').value = this.db.key;
        window.onpopstate = () => this.route();
        this.route();
        // Global listener for YouTube Iframe API to detect video end
        window.onYouTubeIframeAPIReady = () => {};
    },

    onEngineReady() {
        this.engineReady = true;
        document.getElementById('boot-screen').style.display = 'none';
        this.route();
    },

    nav(path) {
        window.history.pushState({}, "", this.basePath + path); 
        this.route(); 
    },

    route() {
        const route = window.location.pathname.replace(this.basePath, '').replace(/^\/|\/$/g, '') || 'home';
        document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        this.cancelAutoplay();

        if (route === 'settings') this.showView('settings');
        else if (route === 'watch') document.getElementById('view-watch').style.display = 'block';
        else if (route === 'search') { this.showView('search'); this.renderSearch(); }
        else if (route === 'history') { this.showView('history'); this.renderHistory(); }
        else { this.showView('home'); this.renderHome(); }
    },

    showView(id) {
        document.getElementById(`view-${id}`).style.display = 'block';
        if (document.getElementById(`link-${id}`)) document.getElementById(`link-${id}`).classList.add('active');
    },

    async search(q) {
        if (!q) return;
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q)}&maxResults=25&type=video&key=${this.db.key}`);
        const data = await res.json();
        this.searchBuffer = data.items.map(i => ({
            id: i.id.videoId, channelId: i.snippet.channelId, channelTitle: i.snippet.channelTitle,
            title: i.snippet.title, thumb: i.snippet.thumbnails.high.url, desc: i.snippet.description
        }));
        this.db.pool = [...this.searchBuffer, ...this.db.pool].slice(0, 200);
        this.save();
        document.getElementById('link-search').style.display = 'flex';
        this.nav('/search');
    },

    renderHome() {
        if (!this.engineReady) return;
        const ranked = JSON.parse(window.pyRanker(JSON.stringify(this.db.pool), JSON.stringify(this.db.brain)));
        this.fillGrid('home-grid', ranked);
    },

    renderSearch() { this.fillGrid('search-grid', this.searchBuffer); },
    renderHistory() { this.fillGrid('history-grid', this.db.brain.history); },

    fillGrid(containerId, list) {
        document.getElementById(containerId).innerHTML = list.map(v => `
            <div class="card" onclick="app.play('${v.id}')">
                <img src="${v.thumb}" style="width:100%; aspect-ratio:16/9; object-fit:cover;">
                <div style="padding:15px;"><div style="font-weight:800; font-size:14px; height:40px; overflow:hidden;">${v.title}</div><div style="color:var(--primary); font-size:11px; margin-top:8px;">${v.channelTitle}</div></div>
            </div>
        `).join('');
    },

    async play(id) {
        const video = [...this.searchBuffer, ...this.db.pool, ...this.db.brain.history, ...this.relatedBuffer].find(v => v.id === id);
        if (!video) return;
        this.activeVideo = video;
        this.db.brain.history = [video, ...this.db.brain.history.filter(v => v.id !== id)].slice(0, 50);
        this.save();
        this.nav('/watch');
        this.cancelAutoplay();

        // Inject Iframe with postMessage enabled to track state
        document.getElementById('theater-mount').innerHTML = `<iframe id="yt-player" src="https://www.youtube-nocookie.com/embed/${id}?autoplay=1&enablejsapi=1" allowfullscreen></iframe>`;
        document.getElementById('t-title').innerText = video.title;
        document.getElementById('t-desc').innerText = video.desc;
        document.getElementById('watch-channel-name').innerText = video.channelTitle;
        document.getElementById('main-scroll').scrollTo(0,0);
        
        this.updateWatchUI();
        await this.fetchRelated(video);
        this.listenForEnd();
    },

    listenForEnd() {
        window.addEventListener("message", (event) => {
            const data = JSON.parse(event.data);
            if (data.event === "infoDelivery" && data.info && data.info.playerState === 0) {
                this.startAutoplayCountdown();
            }
        });
    },

    startAutoplayCountdown() {
        if (!this.relatedBuffer.length) return;
        let count = 7;
        const overlay = document.getElementById('autoplay-overlay');
        const timerTxt = document.getElementById('auto-timer');
        overlay.style.display = 'flex';
        
        this.autoTimer = setInterval(() => {
            count--;
            timerTxt.innerText = count;
            if (count <= 0) {
                this.cancelAutoplay();
                this.play(this.relatedBuffer[0].id);
            }
        }, 1000);
    },

    cancelAutoplay() {
        clearInterval(this.autoTimer);
        document.getElementById('autoplay-overlay').style.display = 'none';
        document.getElementById('auto-timer').innerText = '7';
    },

    async fetchRelated(video) {
        const query = video.title.replace(/[^\w\s]/gi, '').split(' ').slice(0, 4).join(' ');
        const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&maxResults=15&type=video&key=${this.db.key}`);
        const data = await res.json();
        this.relatedBuffer = data.items.map(i => ({
            id: i.id.videoId, channelId: i.snippet.channelId, channelTitle: i.snippet.channelTitle,
            title: i.snippet.title, thumb: i.snippet.thumbnails.high.url, desc: i.snippet.description
        })).filter(v => v.id !== video.id);

        document.getElementById('rec-sidebar').innerHTML = this.relatedBuffer.map(v => `
            <div style="display:flex; gap:12px; cursor:pointer; margin-bottom:12px;" onclick="app.play('${v.id}')">
                <img src="${v.thumb}" style="width:140px; aspect-ratio:16/9; border-radius:8px; object-fit:cover;">
                <div style="font-size:12px; font-weight:800; line-height:1.2;">${v.title.substring(0,40)}...</div>
            </div>
        `).join('');
    },

    updateWatchUI() {
        const isSub = this.db.brain.subs.includes(this.activeVideo.channelId);
        const btn = document.getElementById('btn-sub-watch');
        btn.innerText = isSub ? "SUBSCRIBED" : "SUBSCRIBE";
        btn.style.background = isSub ? "var(--card)" : "var(--text)";
        btn.style.color = isSub ? "var(--text)" : "black";
        
        const isLiked = this.db.brain.liked.includes(this.activeVideo.id);
        document.getElementById('btn-like').style.color = isLiked ? "var(--like)" : "white";
    },

    toggleSub() {
        const cid = this.activeVideo.channelId;
        const idx = this.db.brain.subs.indexOf(cid);
        if (idx > -1) this.db.brain.subs.splice(idx, 1); else this.db.brain.subs.push(cid);
        this.save(); this.updateWatchUI();
    },

    toggleLike() {
        const vid = this.activeVideo.id;
        const idx = this.db.brain.liked.indexOf(vid);
        if (idx > -1) this.db.brain.liked.splice(idx, 1); else this.db.brain.liked.push(vid);
        this.save(); this.updateWatchUI();
    },

    saveKey() { this.db.key = document.getElementById('ytKey').value; this.save(); location.reload(); },
    save() { localStorage.setItem('div_v37', JSON.stringify(this.db)); }
};

window.app = app;
app.init();
</script>
</body>
</html>
